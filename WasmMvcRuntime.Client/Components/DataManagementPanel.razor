@using WasmMvcRuntime.Data.Abstractions
@inject IDataProvider DataProvider
@inject IBackupService BackupService
@inject IJSRuntime JS

<div class="data-management-panel">
    <div class="panel-header">
        <h2>🗄️ Advanced Data Management</h2>
        <p class="subtitle">Backup, Restore, and Cloud Storage</p>
    </div>

    @if (!_isLoaded)
    {
        <div class="loading">
            <div class="spinner-large"></div>
            <p>Loading...</p>
        </div>
    }
    else
    {
        <!-- Database Stats -->
        <div class="stats-section">
            <h3>📊 Database Statistics</h3>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="icon">📋</div>
                    <div class="value">@_stats.TotalTables</div>
                    <div class="label">Tables</div>
                </div>
                <div class="stat-card">
                    <div class="icon">📄</div>
                    <div class="value">@_stats.TotalRecords</div>
                    <div class="label">Records</div>
                </div>
                <div class="stat-card">
                    <div class="icon">💾</div>
                    <div class="value">@FormatBytes(_stats.DatabaseSize)</div>
                    <div class="label">Size</div>
                </div>
                <div class="stat-card">
                    <div class="icon">@(_stats.IsHealthy ? "✅" : "❌")</div>
                    <div class="value">@(_stats.IsHealthy ? "Healthy" : "Issues")</div>
                    <div class="label">Health</div>
                </div>
            </div>

            <!-- Table breakdown -->
            @if (_stats.TableCounts.Any())
            {
                <div class="table-breakdown">
                    <h4>Table Breakdown</h4>
                    <table>
                        <thead>
                            <tr>
                                <th>Table</th>
                                <th>Record Count</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var kvp in _stats.TableCounts.OrderByDescending(x => x.Value))
                            {
                                <tr>
                                    <td>@kvp.Key</td>
                                    <td>@kvp.Value</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>

        <!-- Backup Management -->
        <div class="backup-section">
            <div class="section-header">
                <h3>💾 Backups</h3>
                <button class="btn btn-primary" @onclick="CreateBackup" disabled="@_isProcessing">
                    @if (_isProcessing && _currentOperation == "backup")
                    {
                        <span class="spinner-small"></span>
                        <span>Creating...</span>
                    }
                    else
                    {
                        <span>➕ New Backup</span>
                    }
                </button>
            </div>

            <!-- Backup Options -->
            <div class="backup-options">
                <h4>⚙️ Backup Options</h4>
                <div class="options-grid">
                    <label>
                        <input type="checkbox" @bind="_compress" />
                        Compress File (GZip)
                    </label>
                    <label>
                        <input type="checkbox" @bind="_encrypt" />
                        Encrypt File
                    </label>
                </div>
                @if (_encrypt)
                {
                    <div class="encryption-key">
                        <label>Encryption Key:</label>
                        <input type="password" @bind="_encryptionKey" placeholder="Enter encryption key" />
                    </div>
                }
                <div class="description">
                    <label>Description (optional):</label>
                    <input type="text" @bind="_description" placeholder="Backup description" />
                </div>
            </div>

            <!-- Backups List -->
            <div class="backups-list">
                <h4>📋 Saved Backups</h4>
                @if (_backups.Any())
                {
                    <table class="backups-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Size</th>
                                <th>Type</th>
                                <th>Description</th>
                                <th>Cloud</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var backup in _backups.OrderByDescending(b => b.CreatedAt))
                            {
                                <tr>
                                    <td>@backup.CreatedAt.ToLocalTime().ToString("yyyy-MM-dd HH:mm")</td>
                                    <td>@FormatBytes(backup.Size)</td>
                                    <td>
                                        @if (backup.IsCompressed) { <span class="badge">Compressed</span> }
                                        @if (backup.IsEncrypted) { <span class="badge">Encrypted</span> }
                                    </td>
                                    <td>@(backup.Description ?? "-")</td>
                                    <td>
                                        @if (backup.CloudProviders.Any())
                                        {
                                            @foreach (var cloud in backup.CloudProviders)
                                            {
                                                <span class="cloud-badge">@cloud</span>
                                            }
                                        }
                                        else
                                        {
                                            <span class="text-muted">Local</span>
                                        }
                                    </td>
                                    <td>
                                        <div class="action-buttons">
                                            <button class="btn-icon" @onclick="() => RestoreBackup(backup.Id)" title="Restore">
                                                🔄
                                            </button>
                                            <button class="btn-icon" @onclick="() => ShowUploadDialog(backup.Id)" title="Upload to Cloud">
                                                ☁️
                                            </button>
                                            <button class="btn-icon danger" @onclick="() => DeleteBackup(backup.Id)" title="Delete">
                                                🗑️
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
                else
                {
                    <div class="empty-state">
                        <p>No saved backups found</p>
                        <p class="hint">Create a backup now to protect your data</p>
                    </div>
                }
            </div>
        </div>
    }

    @if (!string.IsNullOrEmpty(_message))
    {
        <div class="message @_messageType">
            @_message
            <button class="close-btn" @onclick="() => _message = string.Empty">✖</button>
        </div>
    }
</div>

@code {
    private DatabaseStats _stats = new();
    private List<BackupMetadata> _backups = new();
    private BackupOptions _backupOptions = new();
    private bool _isLoaded = false;
    private bool _isProcessing = false;
    private string _currentOperation = string.Empty;
    private string _message = string.Empty;
    private string _messageType = "info";
    
    // Temporary properties for collecting values
    private bool _compress = true;
    private bool _encrypt = false;
    private string _encryptionKey = string.Empty;
    private string _description = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        try
        {
            _stats = await DataProvider.GetStatsAsync();
            _backups = await BackupService.ListBackupsAsync();
            _isLoaded = true;
        }
        catch (Exception ex)
        {
            ShowMessage($"Error loading data: {ex.Message}", "error");
        }
    }

    private async Task CreateBackup()
    {
        try
        {
            _isProcessing = true;
            _currentOperation = "backup";
            StateHasChanged();

            // Create new BackupOptions object with values
            var options = new BackupOptions
            {
                Compress = _compress,
                Encrypt = _encrypt,
                EncryptionKey = _encrypt ? _encryptionKey : null,
                Description = string.IsNullOrWhiteSpace(_description) ? null : _description
            };

            var result = await BackupService.CreateBackupAsync(options);

            if (result.Success)
            {
                ShowMessage($"✅ {result.Message} - {FormatBytes(result.BackupSize)}", "success");
                await LoadDataAsync();
                
                // Reset values
                _compress = true;
                _encrypt = false;
                _encryptionKey = string.Empty;
                _description = string.Empty;
            }
            else
            {
                ShowMessage($"❌ {result.Message}", "error");
            }
        }
        catch (Exception ex)
        {
            ShowMessage($"❌ Error: {ex.Message}", "error");
        }
        finally
        {
            _isProcessing = false;
            _currentOperation = string.Empty;
        }
    }

    private async Task RestoreBackup(string backupId)
    {
        var confirmed = await JS.InvokeAsync<bool>("confirm",
            "⚠️ Are you sure you want to restore this backup?\n" +
            "All current data will be replaced!");

        if (!confirmed) return;

        try
        {
            _isProcessing = true;
            _currentOperation = "restore";
            StateHasChanged();

            var result = await BackupService.RestoreBackupAsync(backupId);

            if (result.Success)
            {
                ShowMessage($"✅ {result.Message} - {result.RecordsRestored} records", "success");
                await LoadDataAsync();
            }
            else
            {
                ShowMessage($"❌ {result.Message}", "error");
            }
        }
        catch (Exception ex)
        {
            ShowMessage($"❌ Error: {ex.Message}", "error");
        }
        finally
        {
            _isProcessing = false;
            _currentOperation = string.Empty;
        }
    }

    private async Task DeleteBackup(string backupId)
    {
        var confirmed = await JS.InvokeAsync<bool>("confirm",
            "Are you sure you want to delete this backup?");

        if (!confirmed) return;

        try
        {
            var success = await BackupService.DeleteBackupAsync(backupId);

            if (success)
            {
                ShowMessage("✅ Backup deleted", "success");
                await LoadDataAsync();
            }
            else
            {
                ShowMessage("❌ Deletion failed", "error");
            }
        }
        catch (Exception ex)
        {
            ShowMessage($"❌ Error: {ex.Message}", "error");
        }
    }

    private void ShowUploadDialog(string backupId)
    {
        // TODO: Implement cloud upload dialog
        ShowMessage("Cloud upload feature coming soon...", "info");
    }

    private string FormatBytes(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB", "TB" };
        double len = bytes;
        int order = 0;
        while (len >= 1024 && order < sizes.Length - 1)
        {
            order++;
            len = len / 1024;
        }
        return $"{len:0.##} {sizes[order]}";
    }

    private void ShowMessage(string msg, string type)
    {
        _message = msg;
        _messageType = type;
        StateHasChanged();
    }
}

<style>
    /* Add same styles as UserManagement.razor */
    .data-management-panel {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
    }

    .panel-header {
        text-align: center;
        margin-bottom: 30px;
        padding: 30px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin: 20px 0;
    }

    .stat-card {
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        text-align: center;
    }

    .stat-card .icon {
        font-size: 2.5rem;
        margin-bottom: 10px;
    }

    .stat-card .value {
        font-size: 1.8rem;
        font-weight: bold;
        color: #333;
    }

    .stat-card .label {
        color: #666;
        font-size: 0.9rem;
        margin-top: 5px;
    }

    .backup-section, .stats-section {
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s;
    }

    .btn-primary {
        background: #667eea;
        color: white;
    }

    .btn-primary:hover:not(:disabled) {
        background: #5568d3;
        transform: translateY(-2px);
    }

    .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .backups-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
    }

    .backups-table th {
        background: #f8f9fa;
        padding: 12px;
        text-align: right;
        font-weight: 600;
        border-bottom: 2px solid #dee2e6;
    }

    .backups-table td {
        padding: 12px;
        border-bottom: 1px solid #eee;
    }

    .badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.8rem;
        background: #e3f2fd;
        color: #1976d2;
        margin: 0 2px;
    }

    .message {
        padding: 15px 20px;
        border-radius: 8px;
        margin-top: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .message.success {
        background: #d4edda;
        color: #155724;
    }

    .message.error {
        background: #f8d7da;
        color: #721c24;
    }

    .spinner-large {
        width: 60px;
        height: 60px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto;
    }

    @@keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
