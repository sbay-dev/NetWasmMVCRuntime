<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<style>
.crypto-ctrl{display:flex;gap:12px;align-items:center;padding:10px;background:#1a1a2e;border-radius:8px;border:1px solid #333;margin-bottom:12px;flex-wrap:wrap}
.crypto-ctrl label{font-size:.7rem;color:#aaa;text-transform:uppercase}.crypto-ctrl input[type=range]{width:120px;accent-color:#f85149}
.crypto-metrics{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:8px;padding:10px;background:#0d1117;border-radius:8px;border:1px solid #30363d;margin-bottom:12px}
.crypto-metric{text-align:center}.crypto-metric .num{font-size:1.4rem;font-weight:bold;font-family:monospace}.crypto-metric .lbl{font-size:.6rem;color:#8b949e;text-transform:uppercase}
.crypto-visual{position:relative;height:240px;background:#0a0a1a;border-radius:8px;border:1px solid #333;margin-bottom:12px;overflow:hidden}
.crypto-ring{position:absolute;border-radius:50%;border:2px solid;display:flex;align-items:center;justify-content:center;font-size:.6rem;font-weight:bold;color:#fff;font-family:monospace;transition:all .3s ease}
.crypto-log{max-height:220px;overflow-y:auto;padding:10px;background:#0a0a1a;border-radius:8px;border:1px solid #333;font-family:monospace;font-size:.75rem;color:#8b949e;white-space:pre-wrap}
</style>
<div id="bench-root"></div>

<script>
(function(){
const h = React.createElement;
const {useState, useEffect, useRef, useCallback} = React;
const _bench = window.__cephaBench;
const isAuto = _bench && _bench.active;
const duration = (_bench && _bench.duration) || 8;
const ringColors=['#f85149','#d29922','#f0883e','#3fb950','#667eea','#d2a8ff','#79c0ff','#ff6b9d','#00d4aa','#e0e0e0'];

function App(){
    const [ctrlLayers, setCtrlLayers] = useState(50);
    const [ctrlPayload, setCtrlPayload] = useState(64);
    const [ctrlIter, setCtrlIter] = useState(5);
    const [running, setRunning] = useState(false);
    const [metrics, setMetrics] = useState({fps:0,layer:0,iterSec:0,hashRate:0});
    const [rings, setRings] = useState([]);
    const [logEntries, setLogEntries] = useState(['ðŸ” Matryoshka Encryption â€” Ready.']);
    const logRef = useRef(null);
    const visualRef = useRef(null);
    const stateRef = useRef({running:false,aborted:false,fps:60,frames:0,lastFpsTime:0});
    const animRef = useRef(null);

    const addLog = useCallback((msg,cls)=>{setLogEntries(prev=>[...prev,{msg,cls}]);},[]);
    useEffect(()=>{if(logRef.current)logRef.current.scrollTop=logRef.current.scrollHeight;},[logEntries]);

    const fpsLoop = useCallback(()=>{
        const s=stateRef.current;s.frames++;
        const now=performance.now();
        if(now-s.lastFpsTime>=500){s.fps=Math.round(s.frames*1000/(now-s.lastFpsTime));s.frames=0;s.lastFpsTime=now;}
        if(!s.aborted)animRef.current=requestAnimationFrame(fpsLoop);
    },[]);

    useEffect(()=>{
        stateRef.current.lastFpsTime=performance.now();
        animRef.current=requestAnimationFrame(fpsLoop);
        return()=>{if(animRef.current)cancelAnimationFrame(animRef.current);};
    },[fpsLoop]);

    function yieldFrame(){return new Promise(r=>requestAnimationFrame(r));}
    async function sha256(data){const hash=await crypto.subtle.digest('SHA-256',data);return Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,'0')).join('');}

    const drawRings = useCallback((layer,total)=>{
        const vis=visualRef.current;if(!vis)return;
        const cx=vis.clientWidth/2,cy=vis.clientHeight/2,maxR=Math.min(cx,cy)-10;
        const show=Math.min(layer,15);
        const r=[];
        for(let i=show;i>=0;i--){
            const radius=maxR*(i+1)/(show+2);
            r.push({i,radius,color:ringColors[i%ringColors.length],opacity:i===0?1:.3+.7*(1-i/Math.max(show,1)),label:i===0?'L'+layer+'/'+total:''});
        }
        setRings(r);
    },[]);

    const runMatryoshka = useCallback(async()=>{
        const s=stateRef.current;
        if(s.running)return;s.running=true;s.aborted=false;
        setRunning(true);setLogEntries([]);
        const layers=ctrlLayers, payloadKB=ctrlPayload, iterations=ctrlIter;
        let totalBytes=0,totalHashes=0;
        const tStart=performance.now();

        const payload=new Uint8Array(payloadKB*1024);
        crypto.getRandomValues(payload);
        const originalHash=await sha256(payload);
        addLog('âš¡ Payload: '+payloadKB+'KB, Layers: '+layers+', Iterations: '+iterations,'hot');

        for(let iter=0;iter<iterations&&!s.aborted;iter++){
            addLog('\nðŸ”„ Iteration '+(iter+1)+'/'+iterations,'enc');
            const keys=[];let data=payload;

            const encStart=performance.now();
            for(let L=0;L<layers&&!s.aborted;L++){
                const key=await crypto.subtle.generateKey({name:'AES-GCM',length:256},true,['encrypt','decrypt']);
                const iv=crypto.getRandomValues(new Uint8Array(12));
                const encrypted=await crypto.subtle.encrypt({name:'AES-GCM',iv},key,data);
                keys.push({key,iv});data=new Uint8Array(encrypted);
                totalBytes+=data.byteLength;totalHashes++;
                if(L%5===0||L===layers-1){
                    drawRings(L+1,layers);
                    setMetrics(m=>({...m,fps:s.fps,layer:L+1}));
                    await yieldFrame();
                }
            }
            const encTime=performance.now()-encStart;
            if(s.aborted)break;
            addLog('  ðŸ”’ Encrypted: '+layers+' layers in '+encTime.toFixed(0)+'ms','ok');

            const decStart=performance.now();
            for(let L=keys.length-1;L>=0&&!s.aborted;L--){
                const{key,iv}=keys[L];
                data=new Uint8Array(await crypto.subtle.decrypt({name:'AES-GCM',iv},key,data));
                totalBytes+=data.byteLength;totalHashes++;
                if(L%5===0||L===0){drawRings(L,layers);await yieldFrame();}
            }
            const decTime=performance.now()-decStart;
            const verified=(await sha256(data))===originalHash;
            addLog('  ðŸ”“ Decrypted in '+decTime.toFixed(0)+'ms â€” Integrity: '+(verified?'âœ…':'âŒ'),'ok');
        }

        s.running=false;setRunning(false);
        const elapsed=(performance.now()-tStart)/1000;
        const iterSec=elapsed>0?+(iterations/elapsed).toFixed(2):0;
        const hashRate=elapsed>0?Math.round(totalHashes/elapsed):0;
        setMetrics({fps:s.fps,layer:s.aborted?0:layers,iterSec,hashRate});
        addLog(s.aborted?'\nâ›” Aborted.':'\nðŸ MATRYOSHKA COMPLETE â€” '+iterations+' iters, '+(totalBytes/1024).toFixed(0)+'KB processed',s.aborted?'bad':'ok');

        const score=Math.min(100,Math.round(s.fps*1.5+iterations*5));
        if(_bench&&_bench.active){
            if(_bench.battleMode&&_bench.recordScore)_bench.recordScore('crypto',score);
            else _bench.scores['crypto']=score;
            _bench.next();
        }
    },[ctrlLayers,ctrlPayload,ctrlIter,addLog,drawRings]);

    const abort = useCallback(()=>{stateRef.current.aborted=true;},[]);

    useEffect(()=>{
        if(isAuto){setCtrlLayers(30);setCtrlIter(2);setTimeout(()=>runMatryoshka(),100);}
    },[]);

    const fpsColor=metrics.fps>=50?'#3fb950':metrics.fps>=30?'#d29922':'#f85149';

    return h('div',{style:{maxWidth:'1200px',margin:'0 auto'}},
        h('div',{style:{background:'linear-gradient(135deg,#61dafb,#282c34)',color:'#fff',padding:'6px 16px',borderRadius:'8px',marginBottom:'10px',fontWeight:'bold',fontSize:'.85rem',display:'flex',alignItems:'center',gap:'8px'}},'âš›ï¸ React 18 â€” Virtual DOM + Hooks'),
        h('h2',{style:{margin:'8px 0',fontSize:'1.2rem'}},'ðŸ” Crypto Matryoshka â€” Nested encryption layers'),
        h('div',{className:'crypto-ctrl'},
            h('div',null,h('label',null,'Layers'),h('br'),h('input',{type:'range',min:5,max:200,value:ctrlLayers,onChange:e=>setCtrlLayers(+e.target.value)}),h('span',{style:{color:'#f85149',fontWeight:'bold',marginLeft:'4px'}},ctrlLayers)),
            h('div',null,h('label',null,'Payload KB'),h('br'),h('input',{type:'range',min:1,max:512,value:ctrlPayload,onChange:e=>setCtrlPayload(+e.target.value)}),h('span',{style:{color:'#f85149',fontWeight:'bold',marginLeft:'4px'}},ctrlPayload)),
            h('div',null,h('label',null,'Iterations'),h('br'),h('input',{type:'range',min:1,max:50,value:ctrlIter,onChange:e=>setCtrlIter(+e.target.value)}),h('span',{style:{color:'#f85149',fontWeight:'bold',marginLeft:'4px'}},ctrlIter)),
            h('button',{style:{padding:'6px 16px',border:'none',borderRadius:'6px',background:'#28a745',color:'#fff',fontWeight:'bold',cursor:'pointer'},onClick:runMatryoshka,disabled:running},'â–¶ ENCRYPT'),
            h('button',{style:{padding:'6px 16px',border:'none',borderRadius:'6px',background:'#dc3545',color:'#fff',fontWeight:'bold',cursor:'pointer'},onClick:abort,disabled:!running},'â¹ ABORT')
        ),
        h('div',{className:'crypto-metrics'},
            h('div',{className:'crypto-metric'},h('div',{className:'num',style:{color:fpsColor}},metrics.fps),h('div',{className:'lbl'},'FPS')),
            h('div',{className:'crypto-metric'},h('div',{className:'num',style:{color:'#d2a8ff'}},metrics.layer),h('div',{className:'lbl'},'Layers')),
            h('div',{className:'crypto-metric'},h('div',{className:'num',style:{color:'#f0883e'}},metrics.iterSec),h('div',{className:'lbl'},'Iterations/sec')),
            h('div',{className:'crypto-metric'},h('div',{className:'num',style:{color:'#79c0ff'}},metrics.hashRate),h('div',{className:'lbl'},'Hash Rate'))
        ),
        h('div',{className:'crypto-visual',ref:visualRef},
            rings.map((r,idx)=>{
                const vis=visualRef.current;
                const cx=vis?vis.clientWidth/2:150,cy=vis?vis.clientHeight/2:120;
                return h('div',{key:idx,className:'crypto-ring',
                    style:{width:r.radius*2+'px',height:r.radius*2+'px',left:(cx-r.radius)+'px',top:(cy-r.radius)+'px',borderColor:r.color,opacity:r.opacity}},r.label);
            })
        ),
        h('div',{className:'crypto-log',ref:logRef},
            logEntries.map((entry,i)=>
                typeof entry==='string'?h('div',{key:i},entry):h('div',{key:i,style:{color:entry.cls==='ok'?'#3fb950':entry.cls==='hot'?'#f0883e':entry.cls==='bad'?'#f85149':entry.cls==='enc'?'#d2a8ff':undefined}},entry.msg)
            )
        )
    );
}

ReactDOM.createRoot(document.getElementById('bench-root')).render(h(App));
})();
</script>
