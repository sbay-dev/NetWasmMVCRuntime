<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<style>
.data-ctrl{display:flex;gap:12px;align-items:center;padding:10px;background:#1a1a2e;border-radius:8px;border:1px solid #333;margin-bottom:12px;flex-wrap:wrap}
.data-ctrl label{font-size:.7rem;color:#aaa;text-transform:uppercase}.data-ctrl input[type=range]{width:130px;accent-color:#79c0ff}
.data-metrics{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:8px;padding:10px;background:#0d1117;border-radius:8px;border:1px solid #30363d;margin-bottom:12px}
.data-metric{text-align:center}.data-metric .num{font-size:1.4rem;font-weight:bold;font-family:monospace}.data-metric .lbl{font-size:.6rem;color:#8b949e;text-transform:uppercase}
.data-log{max-height:300px;overflow-y:auto;padding:10px;background:#0a0a1a;border-radius:8px;border:1px solid #333;font-family:monospace;font-size:.75rem;color:#8b949e;white-space:pre-wrap}
</style>
<div id="bench-root"></div>

<script>
(function(){
const h = React.createElement;
const {useState, useEffect, useRef, useCallback} = React;
const _bench = window.__cephaBench;
const isAuto = _bench && _bench.active;
const duration = (_bench && _bench.duration) || 8;

function App(){
    const [ctrlRecords, setCtrlRecords] = useState(500000);
    const [running, setRunning] = useState(false);
    const [metrics, setMetrics] = useState({fps:0,opsPerSec:0,records:0,phase:'Idle'});
    const [logEntries, setLogEntries] = useState(['ðŸ—„ï¸ Data Siege â€” Ready. Adjust records and hit RUN.']);
    const logRef = useRef(null);
    const stateRef = useRef({running:false,aborted:false,fps:60,frames:0,lastFpsTime:0,ops:0});
    const animRef = useRef(null);

    const addLog = useCallback((msg,cls)=>{
        setLogEntries(prev=>[...prev,{msg,cls}]);
    },[]);

    useEffect(()=>{if(logRef.current)logRef.current.scrollTop=logRef.current.scrollHeight;},[logEntries]);

    const fpsLoop = useCallback(()=>{
        const s=stateRef.current;
        s.frames++;
        const now=performance.now();
        if(now-s.lastFpsTime>=500){
            s.fps=Math.round(s.frames*1000/(now-s.lastFpsTime));
            s.frames=0;s.lastFpsTime=now;
        }
        animRef.current=requestAnimationFrame(fpsLoop);
    },[]);

    useEffect(()=>{
        stateRef.current.lastFpsTime=performance.now();
        animRef.current=requestAnimationFrame(fpsLoop);
        return()=>{if(animRef.current)cancelAnimationFrame(animRef.current);};
    },[fpsLoop]);

    function yieldFrame(){return new Promise(r=>requestAnimationFrame(r));}
    function binarySearch(arr,target){let lo=0,hi=arr.length-1;while(lo<=hi){const mid=(lo+hi)>>>1;if(arr[mid].score<target)lo=mid+1;else hi=mid-1;}return lo;}

    const runSiege = useCallback(async()=>{
        const s=stateRef.current;
        if(s.running) return;
        s.running=true;s.aborted=false;s.ops=0;
        setRunning(true);setLogEntries([]);
        const N=ctrlRecords;
        const startTime=performance.now();
        let opsCompleted=0;

        // Phase 1: Generate
        addLog('âš¡ Generating '+N.toLocaleString()+' records...','hot');
        setMetrics(m=>({...m,phase:'Generate',records:0}));
        await yieldFrame();
        const data=new Array(N);
        const batch=50000;
        for(let i=0;i<N&&!s.aborted;i++){
            data[i]={id:i,score:Math.random()*10000,name:'U_'+i+'_'+Math.random().toString(36).substr(2,6),tags:['t_'+Math.floor(Math.random()*500)]};
            if(i%batch===0&&i>0){setMetrics(m=>({...m,records:i,fps:s.fps}));await yieldFrame();}
        }
        if(s.aborted){finish(startTime,N,opsCompleted);return;}
        opsCompleted++;
        addLog('âœ… Generated '+N.toLocaleString()+' in '+((performance.now()-startTime)/1000).toFixed(2)+'s','ok');
        setMetrics(m=>({...m,records:N,fps:s.fps,phase:'Sort'}));

        // Phase 2: Sort
        addLog('âš¡ Sorting by score...','hot');await yieldFrame();
        let t0=performance.now();
        data.sort((a,b)=>a.score-b.score);
        opsCompleted++;
        addLog('âœ… Sort in '+(performance.now()-t0).toFixed(1)+'ms','ok');
        setMetrics(m=>({...m,phase:'Search',fps:s.fps,opsPerSec:Math.round(opsCompleted/((performance.now()-startTime)/1000))}));
        await yieldFrame();

        // Phase 3: Search
        if(!s.aborted){
            addLog('âš¡ Running 10,000 binary searches...','hot');await yieldFrame();
            t0=performance.now();
            for(let i=0;i<10000&&!s.aborted;i++) binarySearch(data,Math.random()*10000);
            opsCompleted++;
            addLog('âœ… 10K searches in '+(performance.now()-t0).toFixed(1)+'ms','ok');
            setMetrics(m=>({...m,phase:'Transform',fps:s.fps}));await yieldFrame();
        }

        // Phase 4: Transform (Filterâ†’Mapâ†’Reduce)
        if(!s.aborted){
            addLog('âš¡ Filter â†’ Map â†’ Reduce chain...','hot');await yieldFrame();
            t0=performance.now();
            const result=data.filter(r=>r.score>5000).map(r=>({id:r.id,doubled:r.score*2})).reduce((sum,r)=>sum+r.doubled,0);
            opsCompleted++;
            addLog('âœ… Chain result: '+result.toFixed(0)+' in '+(performance.now()-t0).toFixed(1)+'ms','ok');
            setMetrics(m=>({...m,phase:'Aggregate',fps:s.fps}));await yieldFrame();
        }

        // Phase 5: Aggregate (GroupBy)
        if(!s.aborted){
            addLog('âš¡ GroupBy tag (Map accumulation)...','hot');await yieldFrame();
            t0=performance.now();
            const groups=new Map();
            for(const r of data){const k=r.tags[0]||'none';if(!groups.has(k))groups.set(k,[]);groups.get(k).push(r.id);}
            opsCompleted++;
            addLog('âœ… '+groups.size+' groups in '+(performance.now()-t0).toFixed(1)+'ms','ok');
        }

        finish(startTime,N,opsCompleted);

        function finish(st,n,ops){
            s.running=false;setRunning(false);
            const elapsed=(performance.now()-st)/1000;
            const opsPerSec=elapsed>0?+(ops/elapsed).toFixed(2):0;
            setMetrics({fps:s.fps,opsPerSec,records:n,phase:s.aborted?'Aborted':'Done'});
            addLog(s.aborted?'â›” Aborted.':'ðŸ SIEGE COMPLETE â€” '+ops+' ops, '+elapsed.toFixed(2)+'s',s.aborted?'bad':'ok');
            const score=Math.min(100,Math.round(s.fps*1.5+opsPerSec*5));
            if(_bench&&_bench.active){
                if(_bench.battleMode&&_bench.recordScore)_bench.recordScore('data',score);
                else _bench.scores['data']=score;
                _bench.next();
            }
        }
    },[ctrlRecords,addLog]);

    const abort = useCallback(()=>{stateRef.current.aborted=true;},[]);

    useEffect(()=>{
        if(isAuto){setCtrlRecords(200000);setTimeout(()=>runSiege(),100);}
    },[]);

    const fpsColor=metrics.fps>=50?'#3fb950':metrics.fps>=30?'#d29922':'#f85149';

    return h('div',{style:{maxWidth:'1200px',margin:'0 auto'}},
        h('div',{style:{background:'linear-gradient(135deg,#61dafb,#282c34)',color:'#fff',padding:'6px 16px',borderRadius:'8px',marginBottom:'10px',fontWeight:'bold',fontSize:'.85rem',display:'flex',alignItems:'center',gap:'8px'}},'âš›ï¸ React 18 â€” Virtual DOM + Hooks'),
        h('h2',{style:{margin:'8px 0',fontSize:'1.2rem'}},'ðŸ—„ï¸ Data Siege â€” Million-object array operations'),
        h('div',{className:'data-ctrl'},
            h('div',null,h('label',null,'Records'),h('br'),h('input',{type:'range',min:10000,max:5000000,step:10000,value:ctrlRecords,onChange:e=>setCtrlRecords(+e.target.value)}),h('span',{style:{color:'#79c0ff',fontWeight:'bold',marginLeft:'4px'}},ctrlRecords.toLocaleString())),
            h('button',{style:{padding:'6px 16px',border:'none',borderRadius:'6px',background:'#28a745',color:'#fff',fontWeight:'bold',cursor:'pointer'},onClick:runSiege,disabled:running},'â–¶ RUN SIEGE'),
            h('button',{style:{padding:'6px 16px',border:'none',borderRadius:'6px',background:'#dc3545',color:'#fff',fontWeight:'bold',cursor:'pointer'},onClick:abort,disabled:!running},'â¹ ABORT')
        ),
        h('div',{className:'data-metrics'},
            h('div',{className:'data-metric'},h('div',{className:'num',style:{color:fpsColor}},metrics.fps),h('div',{className:'lbl'},'FPS')),
            h('div',{className:'data-metric'},h('div',{className:'num',style:{color:'#f0883e'}},metrics.opsPerSec),h('div',{className:'lbl'},'Operations/sec')),
            h('div',{className:'data-metric'},h('div',{className:'num',style:{color:'#79c0ff'}},metrics.records.toLocaleString()),h('div',{className:'lbl'},'Records')),
            h('div',{className:'data-metric'},h('div',{className:'num',style:{color:'#d2a8ff'}},metrics.phase),h('div',{className:'lbl'},'Phase'))
        ),
        h('div',{className:'data-log',ref:logRef},
            logEntries.map((entry,i)=>
                typeof entry==='string'?h('div',{key:i},entry):h('div',{key:i,style:{color:entry.cls==='ok'?'#3fb950':entry.cls==='hot'?'#f0883e':entry.cls==='bad'?'#f85149':undefined}},entry.msg)
            )
        )
    );
}

ReactDOM.createRoot(document.getElementById('bench-root')).render(h(App));
})();
</script>
