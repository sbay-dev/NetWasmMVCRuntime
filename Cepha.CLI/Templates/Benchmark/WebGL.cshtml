<style>
.gl-canvas{width:100%;height:520px;background:#000;border-radius:8px;border:1px solid #333;display:block}
.gl-ctrl{display:flex;gap:12px;align-items:center;padding:10px;background:#1a1a2e;border-radius:8px;border:1px solid #333;margin-bottom:12px;flex-wrap:wrap}
.gl-ctrl label{font-size:.7rem;color:#aaa;text-transform:uppercase}.gl-ctrl input[type=range]{width:110px;accent-color:#667eea}
.gl-metrics{display:grid;grid-template-columns:repeat(auto-fit,minmax(110px,1fr));gap:8px;padding:10px;background:#0d1117;border-radius:8px;border:1px solid #30363d;margin-bottom:12px}
.gl-metric{text-align:center}.gl-metric .num{font-size:1.4rem;font-weight:bold;font-family:monospace}.gl-metric .lbl{font-size:.6rem;color:#8b949e;text-transform:uppercase}
</style>
<div style="max-width:1200px;margin:0 auto;">
    <h2 style="margin:8px 0;font-size:1.2rem;">üíé WebGL Forge ‚Äî GPU particle storm</h2>

    <div class="gl-ctrl">
        <div><label>Particles</label><br><input type="range" id="ctrlParts" min="1000" max="200000" value="50000" step="1000"><span id="valParts" style="color:#667eea;font-weight:bold;margin-left:4px">50000</span></div>
        <div><label>Point Size</label><br><input type="range" id="ctrlSize" min="1" max="8" value="2"><span id="valSize" style="color:#667eea;font-weight:bold;margin-left:4px">2</span></div>
        <div><label>Turbulence</label><br><input type="range" id="ctrlTurb" min="0" max="100" value="40"><span id="valTurb" style="color:#667eea;font-weight:bold;margin-left:4px">40</span></div>
        <button id="btnStart" style="padding:6px 16px;border:none;border-radius:6px;background:#28a745;color:#fff;font-weight:bold;cursor:pointer">‚ñ∂ START</button>
        <button id="btnStop" style="padding:6px 16px;border:none;border-radius:6px;background:#dc3545;color:#fff;font-weight:bold;cursor:pointer" disabled>‚èπ STOP</button>
    </div>

    <div class="gl-metrics">
        <div class="gl-metric"><div class="num" id="mFps" style="color:#3fb950">0</div><div class="lbl">FPS</div></div>
        <div class="gl-metric"><div class="num" id="mVerts" style="color:#667eea">0</div><div class="lbl">Vertices</div></div>
        <div class="gl-metric"><div class="num" id="mDrawCalls" style="color:#f0883e">0</div><div class="lbl">Draw Calls</div></div>
        <div class="gl-metric"><div class="num" id="mGpuTime" style="color:#d2a8ff">0</div><div class="lbl">GPU ms</div></div>
        <div class="gl-metric"><div class="num" id="mFrameTime" style="color:#d29922">0</div><div class="lbl">Frame ms</div></div>
    </div>

    <canvas id="glCanvas" class="gl-canvas"></canvas>
</div>

<script>
(function(){
    const _bench=window.__cephaBench;
    const isAuto=_bench&&_bench.active;
    const duration=(_bench&&_bench.duration)||8;
    const canvas=document.getElementById('glCanvas');
    let gl,running=false,animId,particleCount=50000;
    let fpsFrames=0,lastFpsTime=performance.now(),currentFps=60;
    let posBuffer,velBuffer,positions,velocities,program,timeLoc,sizeLoc,drawCalls=0;

    function resize(){canvas.width=canvas.clientWidth;canvas.height=canvas.clientHeight;if(gl)gl.viewport(0,0,canvas.width,canvas.height);}
    resize();window.addEventListener('resize',resize);

    ['ctrlParts','ctrlSize','ctrlTurb'].forEach(id=>{
        document.getElementById(id).oninput=function(){document.getElementById(id.replace('ctrl','val')).textContent=this.value;};
    });

    const VS=`attribute vec2 aPos;uniform float uTime;uniform float uSize;varying vec3 vColor;
    void main(){
        float angle=uTime*.5+aPos.x*3.0;
        vec2 p=aPos+vec2(sin(angle+aPos.y*10.0),cos(angle+aPos.x*10.0))*.15;
        gl_Position=vec4(p,0,1);gl_PointSize=uSize;
        vColor=vec3(.4+sin(aPos.x*5.0+uTime)*.3,.5+cos(aPos.y*7.0+uTime)*.3,.9);
    }`;
    const FS=`precision mediump float;varying vec3 vColor;
    void main(){
        float d=length(gl_PointCoord-.5);
        if(d>.5)discard;
        float alpha=1.0-d*2.0;
        gl_FragColor=vec4(vColor*alpha,alpha*.8);
    }`;

    function initGL(){
        gl=canvas.getContext('webgl',{antialias:false,alpha:false});
        if(!gl){alert('WebGL not supported');return false;}
        gl.enable(gl.BLEND);gl.blendFunc(gl.SRC_ALPHA,gl.ONE);

        function compile(type,src){
            const s=gl.createShader(type);gl.shaderSource(s,src);gl.compileShader(s);
            if(!gl.getShaderParameter(s,gl.COMPILE_STATUS)){console.error(gl.getShaderInfoLog(s));return null;}return s;
        }
        const vs=compile(gl.VERTEX_SHADER,VS),fs=compile(gl.FRAGMENT_SHADER,FS);
        program=gl.createProgram();gl.attachShader(program,vs);gl.attachShader(program,fs);gl.linkProgram(program);
        gl.useProgram(program);
        timeLoc=gl.getUniformLocation(program,'uTime');
        sizeLoc=gl.getUniformLocation(program,'uSize');
        posBuffer=gl.createBuffer();
        return true;
    }

    function initParticles(n){
        particleCount=n;
        positions=new Float32Array(n*2);velocities=new Float32Array(n*2);
        for(let i=0;i<n;i++){
            const angle=Math.random()*Math.PI*2,r=Math.random()*.8;
            positions[i*2]=Math.cos(angle)*r;positions[i*2+1]=Math.sin(angle)*r;
            velocities[i*2]=(Math.random()-.5)*.01;velocities[i*2+1]=(Math.random()-.5)*.01;
        }
        gl.bindBuffer(gl.ARRAY_BUFFER,posBuffer);gl.bufferData(gl.ARRAY_BUFFER,positions,gl.DYNAMIC_DRAW);
        const aPos=gl.getAttribLocation(program,'aPos');gl.enableVertexAttribArray(aPos);gl.vertexAttribPointer(aPos,2,gl.FLOAT,false,0,0);
    }

    function tick(time){
        if(!running)return;
        const t0=performance.now();
        const turb=+document.getElementById('ctrlTurb').value/1000;
        const pSize=+document.getElementById('ctrlSize').value;
        const t=time*.001;

        // Update particles on main thread (intentionally heavy)
        for(let i=0;i<particleCount;i++){
            const ix=i*2,iy=i*2+1;
            velocities[ix]+=(Math.random()-.5)*turb;velocities[iy]+=(Math.random()-.5)*turb;
            // Attractor toward center
            velocities[ix]-=positions[ix]*.001;velocities[iy]-=positions[iy]*.001;
            positions[ix]+=velocities[ix];positions[iy]+=velocities[iy];
            // Damping
            velocities[ix]*=.999;velocities[iy]*=.999;
            // Bounds
            if(Math.abs(positions[ix])>1){positions[ix]*=.9;velocities[ix]*=-.5;}
            if(Math.abs(positions[iy])>1){positions[iy]*=.9;velocities[iy]*=-.5;}
        }

        gl.bindBuffer(gl.ARRAY_BUFFER,posBuffer);gl.bufferSubData(gl.ARRAY_BUFFER,0,positions);
        gl.clearColor(0,0,0,1);gl.clear(gl.COLOR_BUFFER_BIT);
        gl.uniform1f(timeLoc,t);gl.uniform1f(sizeLoc,pSize);
        gl.drawArrays(gl.POINTS,0,particleCount);
        drawCalls++;

        // FPS
        const now=performance.now();fpsFrames++;
        if(now-lastFpsTime>=500){
            currentFps=Math.round(fpsFrames*1000/(now-lastFpsTime));fpsFrames=0;lastFpsTime=now;
            document.getElementById('mFps').textContent=currentFps;
            document.getElementById('mFps').style.color=currentFps>=50?'#3fb950':currentFps>=30?'#d29922':'#f85149';
            document.getElementById('mDrawCalls').textContent=drawCalls;drawCalls=0;
        }
        document.getElementById('mVerts').textContent=particleCount.toLocaleString();
        document.getElementById('mFrameTime').textContent=(now-t0).toFixed(1);
        document.getElementById('mGpuTime').textContent=(now-t0).toFixed(1);

        animId=requestAnimationFrame(tick);
    }

    function start(){
        if(!gl&&!initGL())return;
        const n=+document.getElementById('ctrlParts').value;
        initParticles(n);running=true;fpsFrames=0;lastFpsTime=performance.now();animId=requestAnimationFrame(tick);
        document.getElementById('btnStart').disabled=true;document.getElementById('btnStop').disabled=false;
    }
    function stop(){running=false;if(animId)cancelAnimationFrame(animId);
        document.getElementById('btnStart').disabled=false;document.getElementById('btnStop').disabled=true;
        if(isAuto&&_bench){
            _bench.scores[_bench.currentTest]=Math.min(100,Math.round(currentFps*1.6));
            history.pushState({},'','/benchmark');
            dispatchEvent(new PopStateEvent('popstate'));
        }
    }
    document.getElementById('btnStart').onclick=start;
    document.getElementById('btnStop').onclick=stop;
    document.getElementById('ctrlParts').onchange=function(){if(running){const n=+this.value;initParticles(n);}};

    if(isAuto){start();setTimeout(stop,duration*1000);}
})();
</script>
