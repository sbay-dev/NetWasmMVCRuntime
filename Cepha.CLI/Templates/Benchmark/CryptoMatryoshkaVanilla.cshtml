<div id="bench-root"></div>

<script>
(function(){
    const _bench=window.__cephaBench;
    const isAuto=_bench&&_bench.active;
    const duration=(_bench&&_bench.duration)||8;
    let running=false,aborted=false,fpsFrames=0,lastFpsTime=performance.now(),currentFps=60,animId;

    // ── Build entire UI from JavaScript (Svelte-compiled style) ──
    const app=document.getElementById('bench-root');

    const style=document.createElement('style');
    style.textContent=`
.crypto-ctrl{display:flex;gap:12px;align-items:center;padding:10px;background:#1a1a2e;border-radius:8px;border:1px solid #333;margin-bottom:12px;flex-wrap:wrap}
.crypto-ctrl label{font-size:.7rem;color:#aaa;text-transform:uppercase}.crypto-ctrl input[type=range]{width:120px;accent-color:#f85149}
.crypto-metrics{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:8px;padding:10px;background:#0d1117;border-radius:8px;border:1px solid #30363d;margin-bottom:12px}
.crypto-metric{text-align:center}.crypto-metric .num{font-size:1.4rem;font-weight:bold;font-family:monospace}.crypto-metric .lbl{font-size:.6rem;color:#8b949e;text-transform:uppercase}
.crypto-visual{position:relative;height:240px;background:#0a0a1a;border-radius:8px;border:1px solid #333;margin-bottom:12px;overflow:hidden}
.crypto-layer{position:absolute;border-radius:50%;border:2px solid;display:flex;align-items:center;justify-content:center;font-size:.6rem;font-weight:bold;color:#fff;font-family:monospace;transition:all .3s ease}
.crypto-log{max-height:220px;overflow-y:auto;padding:10px;background:#0a0a1a;border-radius:8px;border:1px solid #333;font-family:monospace;font-size:.75rem;color:#8b949e;white-space:pre-wrap}
.crypto-log .ok{color:#3fb950}.crypto-log .hot{color:#f0883e}.crypto-log .bad{color:#f85149}.crypto-log .enc{color:#d2a8ff}`;
    document.head.appendChild(style);

    const root=document.createElement('div');
    root.style.cssText='max-width:1200px;margin:0 auto;';

    // Banner
    const banner=document.createElement('div');
    banner.style.cssText='background:#f0883e;color:#fff;padding:6px 14px;border-radius:6px;margin-bottom:8px;font-weight:bold;font-size:.85rem;';
    banner.textContent='\u{1F7E0} Vanilla JS (Svelte-compiled)';
    root.appendChild(banner);

    // Title
    const h2=document.createElement('h2');
    h2.style.cssText='margin:8px 0;font-size:1.2rem;';
    h2.textContent='\u{1F510} Crypto Matryoshka \u2014 Nested encryption layers';
    root.appendChild(h2);

    // Controls
    const ctrl=document.createElement('div');
    ctrl.className='crypto-ctrl';
    function makeSlider(label,id,min,max,val){
        const wrap=document.createElement('div');
        const lbl=document.createElement('label');lbl.textContent=label;
        wrap.appendChild(lbl);wrap.appendChild(document.createElement('br'));
        const inp=document.createElement('input');
        inp.type='range';inp.id=id;inp.min=min;inp.max=max;inp.value=val;
        const sp=document.createElement('span');
        sp.id=id.replace('ctrl','val');sp.style.cssText='color:#f85149;font-weight:bold;margin-left:4px';sp.textContent=val;
        inp.oninput=function(){sp.textContent=this.value;};
        wrap.appendChild(inp);wrap.appendChild(sp);
        return wrap;
    }
    ctrl.appendChild(makeSlider('Layers','ctrlLayers',5,200,50));
    ctrl.appendChild(makeSlider('Payload KB','ctrlPayload',1,512,64));
    ctrl.appendChild(makeSlider('Iterations','ctrlIter',1,50,5));

    const btnRun=document.createElement('button');
    btnRun.id='btnRun';btnRun.style.cssText='padding:6px 16px;border:none;border-radius:6px;background:#28a745;color:#fff;font-weight:bold;cursor:pointer';btnRun.textContent='\u25B6 ENCRYPT';
    const btnAbort=document.createElement('button');
    btnAbort.id='btnAbort';btnAbort.style.cssText='padding:6px 16px;border:none;border-radius:6px;background:#dc3545;color:#fff;font-weight:bold;cursor:pointer';btnAbort.textContent='\u23F9 ABORT';btnAbort.disabled=true;
    ctrl.appendChild(btnRun);ctrl.appendChild(btnAbort);
    root.appendChild(ctrl);

    // Metrics
    const metricsBar=document.createElement('div');
    metricsBar.className='crypto-metrics';
    const metricsDef=[
        {id:'mFps',color:'#3fb950',label:'Main Thread FPS'},
        {id:'mLayer',color:'#d2a8ff',label:'Current Layer',init:'0'},
        {id:'mEncTime',color:'#f0883e',label:'Encrypt ms'},
        {id:'mDecTime',color:'#79c0ff',label:'Decrypt ms'},
        {id:'mBytes',color:'#d29922',label:'Processed KB'},
        {id:'mVerified',color:'#3fb950',label:'Integrity',init:'\u2014'}
    ];
    for(const m of metricsDef){
        const d=document.createElement('div');d.className='crypto-metric';
        const n=document.createElement('div');n.className='num';n.id=m.id;n.style.color=m.color;n.textContent=m.init||'0';
        const l=document.createElement('div');l.className='lbl';l.textContent=m.label;
        d.appendChild(n);d.appendChild(l);metricsBar.appendChild(d);
    }
    root.appendChild(metricsBar);

    // Visual
    const visual=document.createElement('div');
    visual.className='crypto-visual';visual.id='visual';
    root.appendChild(visual);

    // Log
    const logEl=document.createElement('div');
    logEl.className='crypto-log';logEl.id='log';
    logEl.innerHTML='\u{1F510} Matryoshka Encryption \u2014 Ready.\n';
    root.appendChild(logEl);

    app.appendChild(root);

    // ── Crypto logic (identical to original) ──
    function log(msg,cls){logEl.innerHTML+=`<span class="${cls||''}">${msg}</span>\n`;logEl.scrollTop=logEl.scrollHeight;}

    function fpsLoop(){fpsFrames++;const now=performance.now();
        if(now-lastFpsTime>=500){currentFps=Math.round(fpsFrames*1000/(now-lastFpsTime));fpsFrames=0;lastFpsTime=now;
            const el=document.getElementById('mFps');el.textContent=currentFps;el.style.color=currentFps>=50?'#3fb950':currentFps>=30?'#d29922':'#f85149';}
        if(!aborted)animId=requestAnimationFrame(fpsLoop);}
    animId=requestAnimationFrame(fpsLoop);

    function drawMatryoshka(layer,total){
        visual.innerHTML='';
        const cx=visual.clientWidth/2,cy=visual.clientHeight/2;
        const maxR=Math.min(cx,cy)-10;
        const show=Math.min(layer,20);
        const mColors=['#f85149','#d29922','#f0883e','#3fb950','#667eea','#d2a8ff','#79c0ff','#ff6b9d','#00d4aa','#e0e0e0'];
        for(let i=show;i>=0;i--){
            const r=maxR*(i+1)/(show+2);
            const div=document.createElement('div');
            div.className='crypto-layer';
            div.style.cssText=`width:${r*2}px;height:${r*2}px;left:${cx-r}px;top:${cy-r}px;border-color:${mColors[i%mColors.length]};opacity:${i===0?1:.3+.7*(1-i/show)};`;
            if(i===0)div.textContent=`L${layer}/${total}`;
            visual.appendChild(div);
        }
    }

    async function runMatryoshka(){
        if(running)return;running=true;aborted=false;
        btnRun.disabled=true;btnAbort.disabled=false;
        logEl.innerHTML='';
        const layers=+document.getElementById('ctrlLayers').value;
        const payloadKB=+document.getElementById('ctrlPayload').value;
        const iterations=+document.getElementById('ctrlIter').value;
        let totalEncTime=0,totalDecTime=0,totalBytes=0;

        const payload=new Uint8Array(payloadKB*1024);
        crypto.getRandomValues(payload);
        const originalHash=await sha256(payload);
        log(`\u26A1 Payload: ${payloadKB}KB, Layers: ${layers}, Iterations: ${iterations}`,'hot');

        for(let iter=0;iter<iterations&&!aborted;iter++){
            log(`\n\u{1F504} Iteration ${iter+1}/${iterations}`,'enc');
            const keys=[];let data=payload;

            const encStart=performance.now();
            for(let L=0;L<layers&&!aborted;L++){
                const key=await crypto.subtle.generateKey({name:'AES-GCM',length:256},true,['encrypt','decrypt']);
                const iv=crypto.getRandomValues(new Uint8Array(12));
                const encrypted=await crypto.subtle.encrypt({name:'AES-GCM',iv},key,data);
                keys.push({key,iv});
                data=new Uint8Array(encrypted);
                totalBytes+=data.byteLength;
                if(L%5===0||L===layers-1){
                    document.getElementById('mLayer').textContent=L+1;
                    drawMatryoshka(L+1,layers);
                    await yieldFrame();
                }
            }
            const encTime=performance.now()-encStart;
            totalEncTime+=encTime;
            document.getElementById('mEncTime').textContent=Math.round(encTime);
            if(aborted)break;
            log(`  \u{1F512} Encrypted: ${layers} layers in ${encTime.toFixed(0)}ms (${(data.byteLength/1024).toFixed(1)}KB wrapped)`,'ok');

            const decStart=performance.now();
            for(let L=keys.length-1;L>=0&&!aborted;L--){
                const{key,iv}=keys[L];
                const decrypted=await crypto.subtle.decrypt({name:'AES-GCM',iv},key,data);
                data=new Uint8Array(decrypted);
                totalBytes+=data.byteLength;
                if(L%5===0||L===0){
                    document.getElementById('mLayer').textContent=L;
                    drawMatryoshka(L,layers);
                    await yieldFrame();
                }
            }
            const decTime=performance.now()-decStart;
            totalDecTime+=decTime;
            document.getElementById('mDecTime').textContent=Math.round(decTime);

            const finalHash=await sha256(data);
            const verified=finalHash===originalHash;
            document.getElementById('mVerified').textContent=verified?'\u2705 OK':'\u274C FAIL';
            document.getElementById('mVerified').style.color=verified?'#3fb950':'#f85149';
            log(`  \u{1F513} Decrypted: ${layers} layers in ${decTime.toFixed(0)}ms \u2014 Integrity: ${verified?'\u2705':'\u274C'}`,'ok');
        }

        document.getElementById('mBytes').textContent=Math.round(totalBytes/1024);
        log(aborted?'\n\u26D4 Aborted.':
            `\n\u{1F3C1} MATRYOSHKA COMPLETE\n   Total encrypt: ${totalEncTime.toFixed(0)}ms\n   Total decrypt: ${totalDecTime.toFixed(0)}ms\n   Processed: ${(totalBytes/1024).toFixed(0)}KB\n   Main Thread FPS: ${currentFps}`,
            aborted?'bad':'ok');
        running=false;btnRun.disabled=false;btnAbort.disabled=true;

        if(isAuto&&_bench){
            _bench.scores[_bench.currentTest]=Math.min(100,Math.round(currentFps*1.5+iterations*5));
            history.pushState({},'','/benchmark');
            dispatchEvent(new PopStateEvent('popstate'));
        }
    }

    async function sha256(data){
        const hash=await crypto.subtle.digest('SHA-256',data);
        return Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,'0')).join('');
    }

    function yieldFrame(){return new Promise(r=>requestAnimationFrame(r));}

    btnRun.onclick=runMatryoshka;
    btnAbort.onclick=()=>{aborted=true;};

    if(isAuto){document.getElementById('ctrlLayers').value=30;document.getElementById('valLayers').textContent='30';
        document.getElementById('ctrlIter').value=2;document.getElementById('valIter').textContent='2';runMatryoshka();}
})();
</script>
